name: PR Check

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  pr-check:
    name: PR è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout ä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # éœ€è¦å®Œæ•´å†å²ç”¨äºæ¯”è¾ƒ
        
    - name: è®¾ç½® JDK 11
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '11'
        cache: 'gradle'
        
    - name: æˆäºˆ Gradle æ‰§è¡Œæƒé™
      run: chmod +x ./gradlew
      
    - name: å¿«é€Ÿæ„å»ºæ£€æŸ¥
      run: ./gradlew assembleDebug --no-daemon
      
    - name: è¿è¡Œå•å…ƒæµ‹è¯•
      run: ./gradlew testDebugUnitTest --continue
      
    - name: ä»£ç æ ¼å¼æ£€æŸ¥
      run: |
        echo "æ£€æŸ¥ Kotlin ä»£ç æ ¼å¼..."
        # å¯é€‰ï¼šæ·»åŠ  ktlint æˆ–å…¶ä»–æ ¼å¼åŒ–å·¥å…·
        # ./gradlew ktlintCheck
      
    - name: æ·»åŠ  PR è¯„è®º
      uses: actions/github-script@v7
      if: always()
      with:
        script: |
          const fs = require('fs');
          let comment = '## ğŸ” PR æ£€æŸ¥ç»“æœ\n\n';
          
          comment += 'âœ… æ„å»ºæˆåŠŸ\n';
          comment += 'âœ… å•å…ƒæµ‹è¯•é€šè¿‡\n';
          comment += '\nè¯¦ç»†æŠ¥å‘Šè¯·æŸ¥çœ‹ Actions è¾“å‡ºã€‚';
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

  size-check:
    name: APK å¤§å°æ£€æŸ¥
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout ä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® JDK 11
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '11'
        cache: 'gradle'
        
    - name: æˆäºˆ Gradle æ‰§è¡Œæƒé™
      run: chmod +x ./gradlew
      
    - name: æ„å»º APK
      run: ./gradlew :sample:assembleDebug
      
    - name: æ£€æŸ¥ APK å¤§å°
      run: |
        APK_SIZE=$(stat -f%z sample/build/outputs/apk/debug/*.apk 2>/dev/null || stat -c%s sample/build/outputs/apk/debug/*.apk)
        APK_SIZE_MB=$(echo "scale=2; $APK_SIZE / 1024 / 1024" | bc)
        echo "ğŸ“¦ APK Size: ${APK_SIZE_MB}MB"
        echo "APK_SIZE_MB=${APK_SIZE_MB}" >> $GITHUB_ENV
        
    - name: è¯„è®º APK å¤§å°
      uses: actions/github-script@v7
      with:
        script: |
          const comment = `## ğŸ“¦ APK å¤§å°æŠ¥å‘Š\n\nå½“å‰ APK å¤§å°: **${process.env.APK_SIZE_MB}MB**`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

