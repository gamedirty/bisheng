name: PR Check

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  pr-check:
    name: PR 质量检查
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout 代码
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # 需要完整历史用于比较
        
    - name: 设置 JDK 11
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '11'
        cache: 'gradle'
        
    - name: 授予 Gradle 执行权限
      run: chmod +x ./gradlew
      
    - name: 快速构建检查
      run: ./gradlew assembleDebug --no-daemon
      
    - name: 运行单元测试
      run: ./gradlew testDebugUnitTest --continue
      
    - name: 代码格式检查
      run: |
        echo "检查 Kotlin 代码格式..."
        # 可选：添加 ktlint 或其他格式化工具
        # ./gradlew ktlintCheck
      
    - name: 添加 PR 评论
      uses: actions/github-script@v7
      if: always()
      with:
        script: |
          const fs = require('fs');
          let comment = '## 🔍 PR 检查结果\n\n';
          
          comment += '✅ 构建成功\n';
          comment += '✅ 单元测试通过\n';
          comment += '\n详细报告请查看 Actions 输出。';
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

  size-check:
    name: APK 大小检查
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout 代码
      uses: actions/checkout@v4
      
    - name: 设置 JDK 11
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '11'
        cache: 'gradle'
        
    - name: 授予 Gradle 执行权限
      run: chmod +x ./gradlew
      
    - name: 构建 APK
      run: ./gradlew :sample:assembleDebug
      
    - name: 检查 APK 大小
      run: |
        APK_SIZE=$(stat -f%z sample/build/outputs/apk/debug/*.apk 2>/dev/null || stat -c%s sample/build/outputs/apk/debug/*.apk)
        APK_SIZE_MB=$(echo "scale=2; $APK_SIZE / 1024 / 1024" | bc)
        echo "📦 APK Size: ${APK_SIZE_MB}MB"
        echo "APK_SIZE_MB=${APK_SIZE_MB}" >> $GITHUB_ENV
        
    - name: 评论 APK 大小
      uses: actions/github-script@v7
      with:
        script: |
          const comment = `## 📦 APK 大小报告\n\n当前 APK 大小: **${process.env.APK_SIZE_MB}MB**`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

